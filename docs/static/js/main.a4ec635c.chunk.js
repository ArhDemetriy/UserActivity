(this["webpackJsonpreact-template"]=this["webpackJsonpreact-template"]||[]).push([[0],{41:function(t,e,n){},42:function(t,e,n){},43:function(t,e,n){},44:function(t,e,n){},54:function(t,e,n){},55:function(t,e,n){},56:function(t,e,n){},57:function(t,e,n){},58:function(t,e,n){},59:function(t,e,n){"use strict";n.r(e);var a=n(6),i=n.n(a),r=n(26),c=n.n(r),s=(n(41),n(42),n(12)),o=(n(43),n(44),n(1)),u=n.n(o),l=n(3),d=n(0),v=n(2),h=n(20),f=n(33),b=Object(f.a)({apiKey:"AIzaSyAy2GjQAfutCFa3toa9WLDFTkMehtj_CNk",authDomain:"useractivity-4c085.firebaseapp.com",projectId:"useractivity-4c085",storageBucket:"useractivity-4c085.appspot.com",messagingSenderId:"1007647890248",appId:"1:1007647890248:web:91e91fec7ca033ae29b17d"}),j=Object(h.getFirestore)(b),p=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"getCollection",value:function(t){return this.collections.has(t)||this.collections.set(t,h.collection(this.selfFirestore,t)),this.collections.get(t)}},{key:"add",value:function(t,e){return h.addDoc(this.getCollection(t),e)}},{key:"getFirestoreDocs",value:function(t){return h.getDocs(h.collectionGroup(this.selfFirestore,this.getCollection(t).id))}},{key:"deleteCollection",value:function(t){return this.getFirestoreDocs(t).then((function(t){return t.docs.map((function(t){return t.ref}))})).then((function(t){return t.forEach((function(t){return h.deleteDoc(t)}))}))}},{key:"getDocs",value:function(t){return this.getFirestoreDocs(t).then((function(t){return t.docs.map((function(t){return t.data()}))}))}}]),t}();p.selfFirestore=j,p.firestore=h,p.collections=new Map;var g="users",m=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"load",value:function(){return p.getDocs(g).then((function(t){return t.sort((function(t,e){return t.id-e.id}))}))}},{key:"saveAll",value:function(t){return p.deleteCollection(g).then((function(){return Promise.all(t.map((function(t){return p.add(g,t)})))}))}}]),t}(),y=n(11),O=n(35),x="REPLACE_HISTOGRAM",k="REPLACE_SPLINE",N="REPLACE_METRICS",A="SET_RETENTION";function D(t,e){return e.type===x&&e.payload.histogram?Object(y.a)(Object(y.a)({},t),{},{histogram:Object(y.a)(Object(y.a)({},t.histogram),e.payload.histogram)}):e.type===k&&e.payload.spline?Object(y.a)(Object(y.a)({},t),{},{spline:e.payload.spline}):e.type===A&&void 0!==e.payload.retention?Object(y.a)(Object(y.a)({},t),{},{retention:+e.payload.retention}):e.type===N&&void 0!==e.payload.metrics?Object(y.a)(Object(y.a)({},t),{},{metrics:Object(y.a)({},e.payload.metrics)}):t}var S=n(15),T="ADD_USERS",w="REPLACE_USERS";function C(t,e){return e.type===T?t.concat(e.payload.users):e.type===w?Object(S.a)(e.payload.users):t}var I={users:[],graph:{retention:NaN,histogram:{bins:[],maxBin:NaN},spline:[],metrics:{average:NaN,median:NaN,percentile10:NaN,percentile90:NaN}}},M=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:I,e=arguments.length>1?arguments[1]:void 0;return Object(y.a)(Object(y.a)({},t),{},{users:C(t.users,e),graph:D(t.graph,e)})},R=Object(O.a)(M),F=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"addUsers",value:function(t){R.dispatch({type:T,payload:{users:t}})}},{key:"updateUser",value:function(t,e){var n=R.getState().users,a=e;!Number.isFinite(e)||e<0?a=0:e>n.length-1&&(a=n.length-1);var i=n[a];n[a]=Object(y.a)(Object(y.a)({},i),t),R.dispatch({type:w,payload:{users:n}})}},{key:"replaceUsers",value:function(t){R.dispatch({type:w,payload:{users:t}})}},{key:"deleteUsers",value:function(t){var e=R.getState().users;e.splice(t,1),R.dispatch({type:w,payload:{users:e}})}}]),t}();function L(t,e){return{data:t,status:e}}function E(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e?Math.round(10*t*e)/(10*e):0}function U(){return R.getState().users}var _=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"validate",value:function(){return this.validateAllIds()}},{key:"validateAllIds",value:function(){var t,e=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],a=U(),i={},r=!0;a.forEach((function(t,e){var n;if("loading"!==t.id.status){var a=t.id.data;(null===(n=i[a])||void 0===n?void 0:n.length)?(i[a].push(e),r=!1):i[a]=[e]}}));var c=new Set((t=[]).concat.apply(t,Object(S.a)(Object.values(i).filter((function(t){return t.length>1}))))),s=!1,o=a.map((function(t){if(!n&&"valid"===t.id.status)return t;if("loading"===t.id.status)return t;var a=!c.has(t.id.data);return e.updateValidStatusIn(t,{id:{status:a?"valid":"invalid"}})?(s=!0,Object(y.a)({},t)):t}));return s&&F.replaceUsers(o),r}},{key:"validateUserId",value:function(t){var e=U(),n=e[t];if(!(null===n||void 0===n?void 0:n.id))return!1;var a=n.id.data,i=!0;return i=!!Number.isFinite(a)&&e.every((function(e,n){return a!==e.id.data||t===n})),this.updateValidStatusIn(n,{id:{status:i?"valid":"invalid"}})&&F.updateUser(n,t),i}},{key:"validateAllDate",value:function(){var t=this,e=!0;return U().forEach((function(n,a){e=t.validateUserDate(a)&&e})),e}},{key:"validateUserDate",value:function(t){var e,n,a=U()[t];if(!(null===a||void 0===a?void 0:a.registration)||!(null===a||void 0===a?void 0:a.lastActivity))return!1;var i=(null===(e=a.lastActivity.data)||void 0===e?void 0:e.getTime)&&a.lastActivity.data.getTime(),r=(null===(n=a.registration.data)||void 0===n?void 0:n.getTime)&&a.registration.data.getTime(),c=Date.now(),s=i<c,o=!0;return o=s?r<=i:r<c,this.updateValidStatusIn(a,{lastActivity:{status:s?"valid":"invalid"},registration:{status:o?"valid":"invalid"}})&&F.updateUser(a,t),s&&o}},{key:"updateValidStatusIn",value:function(t,e){for(var n=!1,a=0,i=Object.keys(e);a<i.length;a++){var r=i[a];t[r].status!==e[r].status&&(t[r].status=e[r].status,n=!0)}return n}}]),t}(),P=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"init",value:function(){return this.safetyLoad()}},{key:"validate",value:function(){return _.validate()}},{key:"trySave",value:function(){var t=Object(l.a)(u.a.mark((function t(){var e;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.validate()){t.next=2;break}throw new Error("invalid users data");case 2:return n=U(),e=n.map((function(t){return{id:t.id.data,registration:t.registration.data.getTime(),lastActivity:t.lastActivity.data.getTime()}})),t.abrupt("return",m.saveAll(e));case 4:case"end":return t.stop()}var n}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"tryLoad",value:function(){var t=this;return this.separatePromise((function(){return m.load()})).then((function(e){return t.separatePromise((function(){return function(t){return t.map((function(t){return{id:L(t.id,"valid"),registration:L(new Date(t.registration),"valid"),lastActivity:L(new Date(t.lastActivity),"valid")}}))}(e)}))})).then((function(e){return t.separatePromise((function(){return F.replaceUsers(e)}))}))}},{key:"safetyLoad",value:function(){return this.tryLoad().catch((function(t){return console.error(t)}))}},{key:"separatePromise",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Promise((function(n){setTimeout((function(){n(t())}),e)}))}}]),t}();function V(){var t=U();if(Array.isArray(t)&&t.length){var e=t[t.length-1].id.data,n=B();n.id.data=e+1,F.addUsers([n])}else F.addUsers([B()])}function B(){return{id:L(1,"needValidate"),registration:L(new Date,"needValidate"),lastActivity:L(new Date,"needValidate")}}var H=n(4),Y=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"setRetention",value:function(t){R.dispatch({type:A,payload:{retention:t}})}},{key:"replaceHistogram",value:function(t){R.dispatch({type:x,payload:{histogram:t}})}},{key:"pushHistogramBins",value:function(t){var e=R.getState().graph.histogram,n=e.bins.concat(t);R.dispatch({type:x,payload:{histogram:Object(y.a)(Object(y.a)({},e),{},{bins:n})}})}},{key:"replaceSpline",value:function(t){R.dispatch({type:k,payload:{spline:t}})}},{key:"replaceMetrics",value:function(t){R.dispatch({type:N,payload:{metrics:t}})}}]),t}(),z=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"calcAll",value:function(){this.calcHistogram(),setTimeout(this.calcMetrics.bind(this),0),setTimeout(this.calcSpline.bind(this),0)}},{key:"calcHistogram",value:function(){var t=this.getBinLifeTimes(),e=Math.max.apply(Math,Object(S.a)(t)),n=this.normTo1(t,e);Y.replaceHistogram({bins:n,maxBin:e})}},{key:"getBinLifeTimes",value:function(){var t,e=this.getLifeDays(),n=new Array(e.length).fill(0),a=0,i=Object(H.a)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;n[r]+=1,r>a&&(a=r)}}catch(c){i.e(c)}finally{i.f()}return n.slice(0,a+1)}},{key:"normTo1",value:function(t,e){var n=e||Math.max.apply(Math,Object(S.a)(t));return n?t.map((function(t){return t/n})):t}},{key:"getLifeDays",value:function(){return U().map((function(t){return(t.lastActivity.data.getTime()-t.registration.data.getTime())/864e5}))}},{key:"calcMetrics",value:function(){var t=this.getLifeDays().sort(),e={average:this.getAverage(t),median:this.getMedian(t),percentile10:this.getPercentile(t,10),percentile90:this.getPercentile(t,90)};Y.replaceMetrics(e)}},{key:"getAverage",value:function(t){return t.reduce((function(t,e){return t+e}),0)/t.length}},{key:"getMedian",value:function(t){if(t.length%2>0)return t[Math.floor(t.length/2)];var e=Math.round(t.length/2);return.5*(t[e-1]+t[e])}},{key:"getPercentile",value:function(t,e){var n=(t.length-1)*(e/100);if(n===Math.floor(n))return t[n];var a=t[Math.floor(n)];return a+(t[Math.ceil(n)]-a)*(n-Math.floor(n))}},{key:"calcSpline",value:function(){var t,e=function(){var t;return null===(t=R.getState().graph)||void 0===t?void 0:t.histogram}();if(null===e||void 0===e||null===(t=e.bins)||void 0===t?void 0:t.length){for(var n=e.bins,a=[],i=0;i<n.length-1;i++)a.push(n[i]),a.push((n[i]+n[i+1])/2);a.push(n[n.length-1]),Y.replaceSpline(a)}}}]),t}(),G=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"calcRetention",value:function(){var t=this.getRollingRetention(7);Number.isFinite(t)&&Y.setRetention(t)}},{key:"getRollingRetention",value:function(t){if(t<1)return 1;var e,n=this.floorTime(this.getIntervalTime(t)),a=this.floorTime(Date.now()),i=0,r=0,c=U(),s=Object(H.a)(c);try{for(s.s();!(e=s.n()).done;){var o=e.value,u=this.floorTime(o.registration.data.getTime());a-u>=n&&r++,this.floorTime(o.lastActivity.data.getTime())-u>=n&&i++}}catch(l){s.e(l)}finally{s.f()}return r?i/r:NaN}},{key:"getIntervalTime",value:function(t){return t*this.DAY}},{key:"floorTime",value:function(t){return t-t%this.DAY}},{key:"getSimpleRollingRetention",value:function(t){if(t<1)return NaN;var e,n=this.getIntervalTime(t),a=U(),i=0,r=0,c=Date.now(),s=Object(H.a)(a);try{for(s.s();!(e=s.n()).done;){var o=e.value,u=o.registration.data.getTime();c-u<=n?r++:o.lastActivity.data.getTime()-u>=n&&i++}}catch(l){s.e(l)}finally{s.f()}return r?i/r:NaN}}]),t}();function q(){G.calcRetention(),z.calcAll()}G.DAY=864e5;var J=n(13),K=n(5),Q=function(){var t=Object(J.b)((function(t){var e;return(null===(e=t.users)||void 0===e?void 0:e.length)>0})),e=Object(a.useState)(!1),n=Object(s.a)(e,2),i=n[0],r=n[1];return Object(K.jsxs)("div",{className:"controls",children:[Object(K.jsx)("button",{className:"controls-button_add button",type:"button",onClick:V,children:"Add"}),Object(K.jsx)("button",{className:"controls-button_save button",disabled:!t,type:"submit",onClick:function(t){var e;i||(r(!0),e=function(){return r(!1)},P.trySave().then((function(){return P.tryLoad()})).catch((function(t){return console.error(t)})).finally(e))},children:"Save"}),Object(K.jsx)("button",{className:"controls-button_calculate button",disabled:!t,type:"button",onClick:q,children:"Calculate"})]})},W=(n(54),n(55),function(t){var e=t.height,n=void 0===e?500:e,a=Object(J.b)((function(t){return t.graph.histogram.maxBin||0})),i=Object(J.b)((function(t){return t.graph.histogram.bins}));if(!Array.isArray(i))return Object(K.jsx)("svg",{});var r=E(a,2),c=i.map((function(t){return E(t,2)})),s=n,o=50,u=s-100,l=13*c.length+100;function d(t){return Object(K.jsx)("text",{x:"".concat(13*t+o+5),y:"".concat(s-25),textAnchor:"middle",children:"".concat(t)})}return Object(K.jsx)("svg",{width:"".concat(l),height:"".concat(s),textRendering:"optimizeLegibility",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:Object(K.jsxs)("g",{fill:"#4A9DFF",children:[function(){var t=25,e=r/2,n=s-o-u,a=s-o-u/2,i=s-o;return Object(K.jsxs)("g",{stroke:"rgba(74, 157, 255, .4)",children:[Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(n),children:"".concat(r)}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-o),y1:"".concat(n," "),y2:"".concat(n)}),Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(a),children:"".concat(e)}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-o),y1:"".concat(a," "),y2:"".concat(a)}),Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(i),children:"0"}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-o),y1:"".concat(i," "),y2:"".concat(i)})]})}(),c.map((function(t,e){var n=t*u;return Object(K.jsxs)("g",{children:[Object(K.jsx)("rect",{x:"".concat(13*e+o),y:"".concat(s-n-o),width:"".concat(10),height:"".concat(n)}),!(e%5)&&d(e)]},e)})),Object(K.jsx)("g",{stroke:"rgba(74, 157, 255, .4)"})]})})}),X=function(){var t=Object(J.b)((function(t){var e;return!!(null===(e=t.graph.histogram.bins)||void 0===e?void 0:e.length)}));return Object(K.jsx)("div",{className:"histogram",children:t&&Object(K.jsx)(W,{})})},Z=(n(56),function(){var t=Object(J.b)((function(t){return t.graph.retention})),e=Object(J.b)((function(t){return t.graph.metrics}));return Number.isFinite(t)?Object(K.jsxs)("div",{className:"metrics",children:[Object(K.jsx)("span",{children:"Rolling Retention 7 day: ".concat(E(t))}),Object(K.jsx)("span",{children:"LifeTimes:"}),Object(K.jsx)("span",{children:"average : ".concat(E(e.average,1))}),Object(K.jsx)("span",{children:"median : ".concat(E(e.median))}),Object(K.jsx)("span",{children:"10 percentile : ".concat(E(e.percentile10))}),Object(K.jsx)("span",{children:"90 percentile : ".concat(E(e.percentile90))})]}):Object(K.jsx)("div",{})}),$=function(){return Object(K.jsxs)("div",{className:"graph",children:[Object(K.jsx)(Z,{}),Object(K.jsx)(X,{})]})};n(57),n(58);function tt(t){return(null===t||void 0===t?void 0:t.getFullYear)?"".concat(t.getFullYear(),"-").concat((t.getMonth()+1).toString().padStart(2,"0"),"-").concat(t.getDate().toString().padStart(2,"0")):""}function et(t){if(!(null===t||void 0===t?void 0:t.split))return new Date;var e=t.trim().split("-").map((function(t){return parseInt(t)||0})),n=new Date;return e.length&&n.setFullYear(e[0],e[1]-1,e[2]),n}function nt(t,e){var n=U()[e];n&&F.updateUser(Object(y.a)(Object(y.a)({},n),t),e)}var at=function(t){var e=t.index,n=t.requireCssClass,a=Object(J.b)((function(t){var n;return null===(n=t.users[e])||void 0===n?void 0:n.id.data})),i=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.id.status)})),r=Object(J.b)((function(t){var n;return tt(null===(n=t.users[e])||void 0===n?void 0:n.registration.data)})),c=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.registration.status)})),s=Object(J.b)((function(t){var n;return tt(null===(n=t.users[e])||void 0===n?void 0:n.lastActivity.data)})),o=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.lastActivity.status)}));if(!a&&0!==a)return Object(K.jsx)("div",{});var u=n+" user";return Object(K.jsxs)("tr",{className:u,children:[Object(K.jsx)("td",{className:"user-item user-item_first",children:Object(K.jsx)("input",{value:a,name:"userId",min:0,step:1,onChange:function(t){nt({id:L(+t.target.value,"needValidate")},e)},type:"number",className:"user-item-input user-item-input_clear"+(i?"":" user-item-input_invalid"),size:a.toString().length+1})}),Object(K.jsx)("td",{className:"user-item",children:Object(K.jsx)("input",{value:r,max:tt(new Date),name:"registration",onChange:function(t){nt({registration:L(et(t.target.value),"needValidate")},e)},type:"date",className:"user-item-input"+(c?"":" user-item-input_invalid")})}),Object(K.jsx)("td",{className:"user-item",children:Object(K.jsx)("input",{value:s,name:"lastActivity",onChange:function(t){nt({lastActivity:L(et(t.target.value),"needValidate")},e)},type:"date",className:"user-item-input"+(o?"":" user-item-input_invalid")})}),Object(K.jsx)("td",{className:"user-item user-item_last",children:Object(K.jsx)("button",{className:"user-delete_button",type:"button",onClick:function(){!function(t){F.deleteUsers(t)}(e)},children:Object(K.jsx)("img",{src:"/img/trash.svg",alt:"\u0443\u0434\u0430\u043b\u0438\u0442\u044c"})})})]})},it=function(){var t=Object(J.b)((function(t){return t.users}),(function(t,e){return t.length===e.length}));return Object(K.jsxs)("table",{className:"table",children:[Object(K.jsx)("caption",{className:"table-caption",children:"Users activity"}),Object(K.jsx)("thead",{className:"table-head",children:Object(K.jsxs)("tr",{children:[Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"UserID"}),Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"Date Registration"}),Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"Date Last Activity"})]})}),Object(K.jsx)("tbody",{className:"table-body",children:t.map((function(t,e){return Object(K.jsx)(at,{requireCssClass:"table-body-item",index:e},"table-".concat(e,"-").concat(t.id))}))})]})},rt=function(){return Object(K.jsxs)("div",{className:"app",children:[Object(K.jsx)(Q,{}),Object(K.jsxs)("div",{className:"app-data",children:[Object(K.jsx)("div",{className:"app-data-table",children:Object(K.jsx)(it,{})}),Object(K.jsx)($,{})]})]})},ct=function(t){t&&t instanceof Function&&n.e(3).then(n.bind(null,60)).then((function(e){var n=e.getCLS,a=e.getFID,i=e.getFCP,r=e.getLCP,c=e.getTTFB;n(t),a(t),i(t),r(t),c(t)}))};P.init(),c.a.render(Object(K.jsxs)(i.a.StrictMode,{children:[Object(K.jsx)(J.a,{store:R,children:Object(K.jsx)(rt,{})}),","]}),document.getElementById("root")),ct()}},[[59,1,2]]]);
//# sourceMappingURL=main.a4ec635c.chunk.js.map