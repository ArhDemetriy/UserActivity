(this["webpackJsonpreact-template"]=this["webpackJsonpreact-template"]||[]).push([[0],{41:function(t,e,n){},42:function(t,e,n){},43:function(t,e,n){},44:function(t,e,n){},54:function(t,e,n){},55:function(t,e,n){},56:function(t,e,n){},57:function(t,e,n){},58:function(t,e,n){},59:function(t,e,n){"use strict";n.r(e);var a=n(6),i=n.n(a),r=n(26),c=n.n(r),s=(n(41),n(42),n(11)),u=(n(43),n(44),n(1)),o=n.n(u),l=n(3),d=n(0),v=n(2),h=n(20),f=n(33),b=Object(f.a)({apiKey:"AIzaSyAy2GjQAfutCFa3toa9WLDFTkMehtj_CNk",authDomain:"useractivity-4c085.firebaseapp.com",projectId:"useractivity-4c085",storageBucket:"useractivity-4c085.appspot.com",messagingSenderId:"1007647890248",appId:"1:1007647890248:web:91e91fec7ca033ae29b17d"}),j=Object(h.getFirestore)(b),p=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"getCollection",value:function(t){return this.collections.has(t)||this.collections.set(t,h.collection(this.selfFirestore,t)),this.collections.get(t)}},{key:"add",value:function(t,e){return h.addDoc(this.getCollection(t),e)}},{key:"getFirestoreDocs",value:function(t){return h.getDocs(h.collectionGroup(this.selfFirestore,this.getCollection(t).id))}},{key:"deleteCollection",value:function(t){return this.getFirestoreDocs(t).then((function(t){return t.docs.map((function(t){return t.ref}))})).then((function(t){return t.forEach((function(t){return h.deleteDoc(t)}))}))}},{key:"getDocs",value:function(t){return this.getFirestoreDocs(t).then((function(t){return t.docs.map((function(t){return t.data()}))}))}}]),t}();p.selfFirestore=j,p.firestore=h,p.collections=new Map;var g="users",y=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"load",value:function(){return p.getDocs(g).then((function(t){return t.sort((function(t,e){return t.id-e.id}))}))}},{key:"saveAll",value:function(t){return p.deleteCollection(g).then((function(){return Promise.all(t.map((function(t){return p.add(g,t)})))}))}}]),t}(),m=n(12),O=n(35),x="REPLACE_HISTOGRAM",k="REPLACE_SPLINE",N="REPLACE_METRICS",A="SET_RETENTION";function S(t,e){return e.type===x&&e.payload.histogram?Object(m.a)(Object(m.a)({},t),{},{histogram:Object(m.a)(Object(m.a)({},t.histogram),e.payload.histogram)}):e.type===k&&e.payload.spline?Object(m.a)(Object(m.a)({},t),{},{spline:e.payload.spline}):e.type===A&&void 0!==e.payload.retention?Object(m.a)(Object(m.a)({},t),{},{retention:+e.payload.retention}):e.type===N&&void 0!==e.payload.metrics?Object(m.a)(Object(m.a)({},t),{},{metrics:Object(m.a)({},e.payload.metrics)}):t}var D=n(15),T="ADD_USERS",C="REPLACE_USERS";function w(t,e){return e.type===T?t.concat(e.payload.users):e.type===C?Object(D.a)(e.payload.users):t}var I={users:[],graph:{retention:NaN,histogram:{bins:[],maxBin:NaN},spline:[],metrics:{average:NaN,median:NaN,percentile10:NaN,percentile90:NaN}}},F=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:I,e=arguments.length>1?arguments[1]:void 0;return Object(m.a)(Object(m.a)({},t),{},{users:w(t.users,e),graph:S(t.graph,e)})},M=Object(O.a)(F),R=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"addUsers",value:function(t){M.dispatch({type:T,payload:{users:t}})}},{key:"updateUser",value:function(t,e){var n=M.getState().users,a=e;!Number.isFinite(e)||e<0?a=0:e>n.length-1&&(a=n.length-1);var i=n[a];n[a]=Object(m.a)(Object(m.a)({},i),t),M.dispatch({type:C,payload:{users:n}})}},{key:"replaceUsers",value:function(t){M.dispatch({type:C,payload:{users:t}})}},{key:"deleteUser",value:function(t){var e=M.getState().users;e.splice(t,1),M.dispatch({type:C,payload:{users:e}})}}]),t}();function L(t,e){return{data:t,status:e}}function U(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;return e?Math.round(10*t*e)/(10*e):0}function E(){return M.getState().users}var _=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"validate",value:function(){return this.validateAllIds()}},{key:"validateAllIds",value:function(){var t,e=this,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],a=E(),i={},r=!0;a.forEach((function(t,e){var n;if("loading"!==t.id.status){var a=t.id.data;(null===(n=i[a])||void 0===n?void 0:n.length)?(i[a].push(e),r=!1):i[a]=[e]}}));var c=new Set((t=[]).concat.apply(t,Object(D.a)(Object.values(i).filter((function(t){return t.length>1}))))),s=!1,u=a.map((function(t){if(!n&&"valid"===t.id.status)return t;if("loading"===t.id.status)return t;var a=!c.has(t.id.data);return e.updateValidStatusIn(t,{id:{status:a?"valid":"invalid"}})?(s=!0,Object(m.a)({},t)):t}));return s&&R.replaceUsers(u),r}},{key:"validateUserId",value:function(t){var e=E(),n=e[t];if(!(null===n||void 0===n?void 0:n.id))return!1;var a=n.id.data,i=!0;return i=!!Number.isFinite(a)&&e.every((function(e,n){return a!==e.id.data||t===n})),this.updateValidStatusIn(n,{id:{status:i?"valid":"invalid"}})&&R.updateUser(n,t),i}},{key:"validateAllDate",value:function(){var t=this,e=!0;return E().forEach((function(n,a){e=t.validateUserDate(a)&&e})),e}},{key:"validateUserDate",value:function(t){var e,n,a=E()[t];if(!(null===a||void 0===a?void 0:a.registration)||!(null===a||void 0===a?void 0:a.lastActivity))return!1;var i=(null===(e=a.lastActivity.data)||void 0===e?void 0:e.getTime)&&a.lastActivity.data.getTime(),r=(null===(n=a.registration.data)||void 0===n?void 0:n.getTime)&&a.registration.data.getTime(),c=Date.now(),s=i<c,u=!0;return u=s?r<=i:r<c,this.updateValidStatusIn(a,{lastActivity:{status:s?"valid":"invalid"},registration:{status:u?"valid":"invalid"}})&&R.updateUser(a,t),s&&u}},{key:"updateValidStatusIn",value:function(t,e){for(var n=!1,a=0,i=Object.keys(e);a<i.length;a++){var r=i[a];t[r].status!==e[r].status&&(t[r].status=e[r].status,n=!0)}return n}}]),t}(),P=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"init",value:function(){return this.safetyLoad()}},{key:"validate",value:function(){return _.validate()}},{key:"trySave",value:function(){var t=Object(l.a)(o.a.mark((function t(){var e;return o.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.validate()){t.next=2;break}throw new Error("invalid users data");case 2:return n=E(),e=n.map((function(t){return{id:t.id.data,registration:t.registration.data.getTime(),lastActivity:t.lastActivity.data.getTime()}})),t.abrupt("return",y.saveAll(e));case 4:case"end":return t.stop()}var n}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"tryLoad",value:function(){var t=this;return this.separatePromise((function(){return y.load()})).then((function(e){return t.separatePromise((function(){return function(t){return t.map((function(t){return{id:L(t.id,"valid"),registration:L(new Date(t.registration),"valid"),lastActivity:L(new Date(t.lastActivity),"valid")}}))}(e)}))})).then((function(e){return t.separatePromise((function(){return R.replaceUsers(e)}))}))}},{key:"safetyLoad",value:function(){return this.tryLoad().catch((function(t){return console.error(t)}))}},{key:"separatePromise",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Promise((function(n){setTimeout((function(){n(t())}),e)}))}}]),t}();function B(){var t=E();if(Array.isArray(t)&&t.length){var e=t[t.length-1].id.data,n=V();n.id.data=e+1,R.addUsers([n])}else R.addUsers([V()])}function V(){return{id:L(1,"needValidate"),registration:L(new Date,"needValidate"),lastActivity:L(new Date,"needValidate")}}var H=n(4),Y=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"setRetention",value:function(t){M.dispatch({type:A,payload:{retention:t}})}},{key:"replaceHistogram",value:function(t){M.dispatch({type:x,payload:{histogram:t}})}},{key:"pushHistogramBins",value:function(t){var e=M.getState().graph.histogram,n=e.bins.concat(t);M.dispatch({type:x,payload:{histogram:Object(m.a)(Object(m.a)({},e),{},{bins:n})}})}},{key:"replaceSpline",value:function(t){M.dispatch({type:k,payload:{spline:t}})}},{key:"replaceMetrics",value:function(t){M.dispatch({type:N,payload:{metrics:t}})}}]),t}(),z=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"calcAll",value:function(){this.calcHistogram(),setTimeout(this.calcMetrics.bind(this),0),setTimeout(this.calcSpline.bind(this),0)}},{key:"calcHistogram",value:function(){var t=this.getBinLifeTimes(),e=Math.max.apply(Math,Object(D.a)(t)),n=this.normTo1(t,e);Y.replaceHistogram({bins:n,maxBin:e})}},{key:"getBinLifeTimes",value:function(){var t,e=this.getLifeDays(),n=new Array(e.length).fill(0),a=0,i=Object(H.a)(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;n[r]+=1,r>a&&(a=r)}}catch(c){i.e(c)}finally{i.f()}return n.slice(0,a+1)}},{key:"normTo1",value:function(t,e){var n=e||Math.max.apply(Math,Object(D.a)(t));return n?t.map((function(t){return t/n})):t}},{key:"getLifeDays",value:function(){return E().map((function(t){return(t.lastActivity.data.getTime()-t.registration.data.getTime())/864e5}))}},{key:"calcMetrics",value:function(){var t=this.getLifeDays().sort(),e={average:this.getAverage(t),median:this.getMedian(t),percentile10:this.getPercentile(t,10),percentile90:this.getPercentile(t,90)};Y.replaceMetrics(e)}},{key:"getAverage",value:function(t){return t.reduce((function(t,e){return t+e}),0)/t.length}},{key:"getMedian",value:function(t){if(t.length%2>0)return t[Math.floor(t.length/2)];var e=Math.round(t.length/2);return.5*(t[e-1]+t[e])}},{key:"getPercentile",value:function(t,e){var n=(t.length-1)*(e/100);if(n===Math.floor(n))return t[n];var a=t[Math.floor(n)];return a+(t[Math.ceil(n)]-a)*(n-Math.floor(n))}},{key:"calcSpline",value:function(){var t,e=function(){var t;return null===(t=M.getState().graph)||void 0===t?void 0:t.histogram}();if(null===e||void 0===e||null===(t=e.bins)||void 0===t?void 0:t.length){for(var n=e.bins,a=[],i=0;i<n.length-1;i++)a.push(n[i]),a.push((n[i]+n[i+1])/2);a.push(n[n.length-1]),Y.replaceSpline(a)}}}]),t}(),G=function(){function t(){Object(d.a)(this,t)}return Object(v.a)(t,null,[{key:"calcRetention",value:function(){var t=this.getRollingRetention(7);Number.isFinite(t)&&Y.setRetention(t)}},{key:"getRollingRetention",value:function(t){if(t<1)return 1;var e,n=this.floorTime(this.getIntervalTime(t)),a=this.floorTime(Date.now()),i=0,r=0,c=E(),s=Object(H.a)(c);try{for(s.s();!(e=s.n()).done;){var u=e.value,o=this.floorTime(u.registration.data.getTime());a-o>=n&&r++,this.floorTime(u.lastActivity.data.getTime())-o>=n&&i++}}catch(l){s.e(l)}finally{s.f()}return r?i/r:NaN}},{key:"getIntervalTime",value:function(t){return t*this.DAY}},{key:"floorTime",value:function(t){return t-t%this.DAY}},{key:"getSimpleRollingRetention",value:function(t){if(t<1)return NaN;var e,n=this.getIntervalTime(t),a=E(),i=0,r=0,c=Date.now(),s=Object(H.a)(a);try{for(s.s();!(e=s.n()).done;){var u=e.value,o=u.registration.data.getTime();c-o<=n?r++:u.lastActivity.data.getTime()-o>=n&&i++}}catch(l){s.e(l)}finally{s.f()}return r?i/r:NaN}}]),t}();function q(){G.calcRetention(),z.calcAll()}G.DAY=864e5;var J=n(13),K=n(5),Q=function(){var t=Object(J.b)((function(t){var e;return(null===(e=t.users)||void 0===e?void 0:e.length)>0})),e=Object(a.useState)(!1),n=Object(s.a)(e,2),i=n[0],r=n[1];return Object(K.jsxs)("div",{className:"controls",children:[Object(K.jsx)("button",{className:"controls-button_add button",type:"button",onClick:B,children:"Add"}),Object(K.jsx)("button",{className:"controls-button_save button",disabled:!t,type:"submit",onClick:function(t){var e;i||(r(!0),e=function(){return r(!1)},P.trySave().then((function(){return P.tryLoad()})).catch((function(t){return console.error(t)})).finally(e))},children:"Save"}),Object(K.jsx)("button",{className:"controls-button_calculate button",disabled:!t,type:"button",onClick:q,children:"Calculate"})]})},W=(n(54),n(55),function(t){var e=t.height,n=void 0===e?500:e,a=Object(J.b)((function(t){return t.graph.histogram.maxBin||0})),i=Object(J.b)((function(t){return t.graph.histogram.bins}));if(!Array.isArray(i))return Object(K.jsx)("svg",{});var r=U(a,2),c=i.map((function(t){return U(t,2)})),s=n,u=50,o=s-100,l=13*c.length+100;function d(t){return Object(K.jsx)("text",{x:"".concat(13*t+u+5),y:"".concat(s-25),textAnchor:"middle",children:"".concat(t)})}return Object(K.jsx)("svg",{width:"".concat(l),height:"".concat(s),textRendering:"optimizeLegibility",version:"1.1",xmlns:"http://www.w3.org/2000/svg",children:Object(K.jsxs)("g",{fill:"#4A9DFF",children:[function(){var t=25,e=r/2,n=s-u-o,a=s-u-o/2,i=s-u;return Object(K.jsxs)("g",{stroke:"rgba(74, 157, 255, .4)",children:[Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(n),children:"".concat(r)}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-u),y1:"".concat(n," "),y2:"".concat(n)}),Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(a),children:"".concat(e)}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-u),y1:"".concat(a," "),y2:"".concat(a)}),Object(K.jsx)("text",{x:"".concat(t),textAnchor:"middle",y:"".concat(i),children:"0"}),Object(K.jsx)("line",{x1:"".concat(t),x2:"".concat(l-u),y1:"".concat(i," "),y2:"".concat(i)})]})}(),c.map((function(t,e){var n=t*o;return Object(K.jsxs)("g",{children:[Object(K.jsx)("rect",{x:"".concat(13*e+u),y:"".concat(s-n-u),width:"".concat(10),height:"".concat(n)}),!(e%5)&&d(e)]},e)})),Object(K.jsx)("g",{stroke:"rgba(74, 157, 255, .4)"})]})})}),X=function(){var t=Object(J.b)((function(t){var e;return!!(null===(e=t.graph.histogram.bins)||void 0===e?void 0:e.length)}));return Object(K.jsx)("div",{className:"histogram",children:t&&Object(K.jsx)(W,{})})},Z=(n(56),function(){var t=Object(J.b)((function(t){return t.graph.retention})),e=Object(J.b)((function(t){return t.graph.metrics}));return Number.isFinite(t)?Object(K.jsxs)("div",{className:"metrics",children:[Object(K.jsx)("span",{children:"Rolling Retention 7 day: ".concat(U(t))}),Object(K.jsx)("span",{children:"LifeTimes:"}),Object(K.jsx)("span",{children:"average : ".concat(U(e.average,1))}),Object(K.jsx)("span",{children:"median : ".concat(U(e.median))}),Object(K.jsx)("span",{children:"10 percentile : ".concat(U(e.percentile10))}),Object(K.jsx)("span",{children:"90 percentile : ".concat(U(e.percentile90))})]}):Object(K.jsx)("div",{})}),$=function(){return Object(K.jsxs)("div",{className:"graph",children:[Object(K.jsx)(Z,{}),Object(K.jsx)(X,{})]})},tt=(n(57),n(58),n(9));function et(t){var e,n,a;"id"===t.key?(e=at,n=_.validateUserId.bind(_),a=function(t){return t}):"lastActivity"!==t.key&&"registration"!==t.key||(e=nt,n=_.validateUserDate.bind(_),a=it);var i=t.index,r=t.key,c=t.changeCallback;return function(t){var s=e(t.target.value);if(null!==s){R.updateUser(Object(tt.a)({},r,L(s,"valid")),i),n(i);var u=E()[i];c(a(u[r].data))}}}function nt(t){if(!(null===t||void 0===t?void 0:t.split))return null;var e=t.trim().split("-").map((function(t){return parseInt(t)}));if(e.length<3||!e.every((function(t){return Number.isFinite(t)&&t>=0})))return null;var n=new Date(0);return n.setFullYear(e[0],e[1]-1,e[2]),n}function at(t){return+t}function it(t){return(null===t||void 0===t?void 0:t.getFullYear)?"".concat(t.getFullYear(),"-").concat((t.getMonth()+1).toString().padStart(2,"0"),"-").concat(t.getDate().toString().padStart(2,"0")):""}var rt=function(t){var e=t.index,n=t.requireCssClass,i=Object(J.b)((function(t){var n;return null===(n=t.users[e])||void 0===n?void 0:n.id.data})),r=Object(a.useState)(i),c=Object(s.a)(r,2),u=c[0],o=c[1],l=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.id.status)})),d=Object(J.b)((function(t){var n;return it(null===(n=t.users[e])||void 0===n?void 0:n.registration.data)})),v=Object(a.useState)(d),h=Object(s.a)(v,2),f=h[0],b=h[1],j=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.registration.status)})),p=Object(J.b)((function(t){var n;return it(null===(n=t.users[e])||void 0===n?void 0:n.lastActivity.data)})),g=Object(a.useState)(p),y=Object(s.a)(g,2),m=y[0],O=y[1],x=Object(J.b)((function(t){var n;return"invalid"!==(null===(n=t.users[e])||void 0===n?void 0:n.lastActivity.status)}));if(!u&&0!==u)return Object(K.jsx)("div",{});var k=n+" user";return Object(K.jsxs)("tr",{className:k,children:[Object(K.jsx)("td",{className:"user-item user-item_first",children:Object(K.jsx)("input",{value:u,name:"userId",min:0,step:1,onChange:function(t){return o(+t.target.value)},onBlur:et({key:"id",index:e,changeCallback:function(t){o(t)}}),type:"number",className:"user-item-input user-item-input_clear"+(l?"":" user-item-input_invalid"),size:u.toString().length+1})}),Object(K.jsx)("td",{className:"user-item",children:Object(K.jsx)("input",{value:f,name:"registration",max:it(new Date),onChange:function(t){return b(t.target.value)},onBlur:et({key:"registration",index:e,changeCallback:function(t){b(t)}}),type:"date",className:"user-item-input"+(j?"":" user-item-input_invalid")})}),Object(K.jsx)("td",{className:"user-item",children:Object(K.jsx)("input",{value:m,name:"lastActivity",max:it(new Date),onChange:function(t){return O(t.target.value)},onBlur:et({key:"lastActivity",index:e,changeCallback:function(t){O(t)}}),type:"date",className:"user-item-input"+(x?"":" user-item-input_invalid")})}),Object(K.jsx)("td",{className:"user-item user-item_last",children:Object(K.jsx)("button",{className:"user-delete_button",type:"button",onClick:function(){!function(t){R.deleteUser(t)}(e)},children:Object(K.jsx)("img",{src:"/img/trash.svg",alt:"\u0443\u0434\u0430\u043b\u0438\u0442\u044c"})})})]})},ct=function(){var t=Object(J.b)((function(t){return t.users}),(function(t,e){return t.length===e.length}));return Object(K.jsxs)("table",{className:"table",children:[Object(K.jsx)("caption",{className:"table-caption",children:"Users activity"}),Object(K.jsx)("thead",{className:"table-head",children:Object(K.jsxs)("tr",{children:[Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"UserID"}),Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"Date Registration"}),Object(K.jsx)("th",{className:"table-head-item",scope:"col",children:"Date Last Activity"})]})}),Object(K.jsx)("tbody",{className:"table-body",children:t.map((function(t,e){return Object(K.jsx)(rt,{requireCssClass:"table-body-item",index:e},"table-".concat(e,"-").concat(t.id))}))})]})},st=function(){return Object(K.jsxs)("div",{className:"app",children:[Object(K.jsx)(Q,{}),Object(K.jsxs)("div",{className:"app-data",children:[Object(K.jsx)("div",{className:"app-data-table",children:Object(K.jsx)(ct,{})}),Object(K.jsx)($,{})]})]})},ut=function(t){t&&t instanceof Function&&n.e(3).then(n.bind(null,60)).then((function(e){var n=e.getCLS,a=e.getFID,i=e.getFCP,r=e.getLCP,c=e.getTTFB;n(t),a(t),i(t),r(t),c(t)}))};P.init(),c.a.render(Object(K.jsxs)(i.a.StrictMode,{children:[Object(K.jsx)(J.a,{store:M,children:Object(K.jsx)(st,{})}),","]}),document.getElementById("root")),ut()}},[[59,1,2]]]);
//# sourceMappingURL=main.4de61994.chunk.js.map